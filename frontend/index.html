<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Comprar Entradas - EcoHarmony Park</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --gap: 12px; }
    body { font-family: system-ui, Arial, sans-serif; max-width: 900px; margin: 24px auto; padding: 0 12px; }
    h1 { margin: 8px 0 16px; }
    fieldset { margin-bottom: 16px; border: 1px solid #ddd; border-radius: 10px; padding: 12px; }
    legend { padding: 0 6px; }
    label { display:block; margin: 6px 0; }
    input, select, button { padding: 10px; width: 100%; box-sizing: border-box; }
    .row { display:flex; gap: var(--gap); flex-wrap: wrap; }
    .row > div { flex: 1 1 240px; min-width: 220px; }
    .price-line { display:flex; justify-content: space-between; margin-top: 6px; }
    .muted { color:#666; font-size: 0.95rem; }
    .total { font-size: 1.15rem; font-weight: 600; }
    .chips { margin-top: 10px; }
    .chip { display:inline-block; padding:6px 10px; border:1px solid #ddd; border-radius:999px; margin:4px 6px 0 0; }
    .ok { color: #0a0; }
    .err { color: #a00; }
    .panel { border:1px solid #eee; border-radius:10px; padding:10px; background:#fafafa; }
  </style>
</head>
<body>
  <h1>Comprar Entradas</h1>

  <fieldset>
    <legend>Datos de compra</legend>
    <div class="row">
      <div>
        <label>Email del comprador
          <input id="email" type="email" placeholder="tu@email.com" required />
        </label>
      </div>
      <div>
        <label>Fecha de visita
          <input id="date" type="date" required />
        </label>
      </div>
      <div>
        <label>Forma de pago
          <select id="payment">
            <option value="Unspecified">-- Seleccionar --</option>
            <option value="Cash">Efectivo (boletería)</option>
            <option value="Card">Tarjeta (Mercado Pago)</option>
          </select>
        </label>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Entradas</legend>
    <div class="row">
      <div class="panel">
        <strong>Pase Regular</strong>
        <div class="muted">Precio: $15.000</div>
        <label style="margin-top:8px;">Cantidad
          <input id="qtyRegular" type="number" min="0" max="10" value="2" />
        </label>
      </div>
      <div class="panel">
        <strong>Pase VIP</strong>
        <div class="muted">Precio: $25.000</div>
        <label style="margin-top:8px;">Cantidad
          <input id="qtyVip" type="number" min="0" max="10" value="1" />
        </label>
      </div>
    </div>

    <div class="panel" style="margin-top:12px;">
      <div class="price-line muted"><span>Subtotal Regular</span><span id="subReg">$0</span></div>
      <div class="price-line muted"><span>Subtotal VIP</span><span id="subVip">$0</span></div>
      <div class="price-line total"><span>Total</span><span id="total">$0</span></div>
      <div class="muted" style="margin-top:6px;">Máximo 10 entradas por compra.</div>
    </div>
  </fieldset>

  <button id="buyBtn">Comprar</button>
  <div id="out" style="margin-top:16px;"></div>

<script>
const apiBase = "http://localhost:5080"; // asegurate que coincide con tu API
const PRICE_REG = 15000;
const PRICE_VIP = 25000;

const $ = (id) => document.getElementById(id);
const fmt = (n) => n.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 });

function recalc() {
  const qR = parseInt($("qtyRegular").value || "0", 10);
  const qV = parseInt($("qtyVip").value || "0", 10);
  const subR = qR * PRICE_REG;
  const subV = qV * PRICE_VIP;
  const total = subR + subV;
  $("subReg").textContent = fmt(subR);
  $("subVip").textContent = fmt(subV);
  $("total").textContent = fmt(total);
}

// Setear min de la fecha = hoy
(function setMinDate() {
  const today = new Date();
  const iso = today.toISOString().slice(0,10);
  $("date").setAttribute("min", iso);
})();

$("qtyRegular").addEventListener("input", recalc);
$("qtyVip").addEventListener("input", recalc);
recalc();

function isParkOpen(dateStr) {
  // Mantiene coherencia con tu SimpleCalendar (mié–dom abierto)
  const d = new Date(dateStr + "T00:00:00");
  const day = d.getUTCDay(); // 0=Dom,1=Lun,...,6=Sáb
  return day === 0 || day === 3 || day === 4 || day === 5 || day === 6; // Dom, Mié, Jue, Vie, Sáb
}

function validateForm() {
  const errors = [];

  const email = $("email").value.trim();
  const date = $("date").value;  // NO default
  const payment = $("payment").value;
  const qR = parseInt($("qtyRegular").value || "0", 10);
  const qV = parseInt($("qtyVip").value || "0", 10);
  const totalQty = qR + qV;

  // Cantidad
  if (totalQty <= 0) errors.push("Debés seleccionar al menos 1 entrada.");
  if (totalQty > 10) errors.push("La cantidad de entradas no debe ser mayor a 10.");

  // Forma de pago
  if (payment === "Unspecified") errors.push("Debés seleccionar la forma de pago.");

  // Email (validación simple)
  if (!email) {
    errors.push("Debés ingresar un email.");
  } else {
    const simpleEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!simpleEmail.test(email)) errors.push("El email no tiene un formato válido.");
  }

  // Fecha requerida
  if (!date) {
    errors.push("Debés seleccionar la fecha de visita.");
  } else {
    // Fecha ≥ hoy (usando zona local)
    const selected = new Date(date + "T00:00:00");
    const today = new Date();
    today.setHours(0,0,0,0);
    if (selected < today) errors.push("La fecha de visita debe ser hoy o una fecha futura.");

    // Opcional: validar apertura local para feedback inmediato
    if (!isParkOpen(date)) errors.push("El parque está cerrado en esa fecha (abre de miércoles a domingo).");
  }

  return errors;
}

$("buyBtn").addEventListener("click", async () => {
  const out = $("out");
  out.textContent = "Procesando…";

  const errors = validateForm();
  if (errors.length > 0) {
    // Mostrar TODOS los errores juntos
    out.innerHTML = `<div class="err">
      <strong>No se puede continuar:</strong>
      <ul>${errors.map(e => `<li>${e}</li>`).join("")}</ul>
    </div>`;
    return;
  }

  const email = $("email").value.trim();
  const date = $("date").value;
  const payment = $("payment").value;
  const qR = parseInt($("qtyRegular").value || "0", 10);
  const qV = parseInt($("qtyVip").value || "0", 10);

  // Construimos visitantes (Age placeholder 25 para compatibilidad con backend actual)
  const visitors = [
    ...Array.from({ length: qR }, () => ({ age: 25, passType: "Regular" })),
    ...Array.from({ length: qV }, () => ({ age: 25, passType: "Vip" })),
  ];

  const req = {
    userId: (crypto.randomUUID && crypto.randomUUID()) || "11111111-1111-1111-1111-111111111111",
    buyerEmail: email,
    visitDate: date, // NO default: ya validado arriba
    visitors,
    paymentMethod: payment,
    currency: "ARS"
  };

  try {
    $("buyBtn").disabled = true;

    const r = await fetch(apiBase + "/tickets/purchase", {
      method: "POST",
      headers: { "Content-Type": "application/json"},
      body: JSON.stringify(req)
    });

    const data = await r.json();

    if (!r.ok) {
      out.innerHTML = `<div class="err"><strong>Error:</strong> ${data.error || "Solicitud inválida"}</div>`;
      return;
    }

    let html = `<p class="ok"><strong>OK</strong> – ${data.confirmationMessage}</p>`;
    html += `<div class="chips">
      <span class="chip">Entradas: ${data.ticketsCount}</span>
      <span class="chip">Fecha: ${data.visitDate}</span>
    </div>`;

    // Total oficial de API (si viene)
    if (typeof data.totalAmount === "number" && data.totalAmount >= 0) {
      const totalFmt = data.totalAmount.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 });
      html += `<div class="panel" style="margin-top:8px;">
        <div class="price-line total"><span>Total (API)</span><span>${totalFmt}</span></div>
      </div>`;
    } else {
      // Fallback: cálculo cliente
      const subR = qR * PRICE_REG;
      const subV = qV * PRICE_VIP;
      const total = subR + subV;
      html += `<div class="panel" style="margin-top:8px;">
        <div class="price-line muted"><span>Subtotal Regular</span><span>${fmt(subR)}</span></div>
        <div class="price-line muted"><span>Subtotal VIP</span><span>${fmt(subV)}</span></div>
        <div class="price-line total"><span>Total</span><span>${fmt(total)}</span></div>
      </div>`;
    }

    // Link de checkout si corresponde
    const hasRedirect = typeof data.paymentRedirectUrl === "string" && data.paymentRedirectUrl.trim().length > 0;
    if (hasRedirect) {
      html += `
        <div class="panel" style="margin-top:10px;">
          <div class="price-line"><span>Checkout</span>
            <span><a href="${data.paymentRedirectUrl}" target="_blank" rel="noopener">Ir al checkout</a></span>
          </div>
          <div class="muted" style="margin-top:6px;">
            URL:
            <input type="text" value="${data.paymentRedirectUrl}" readonly style="width:100%; background:#fff; border:1px solid #ddd; border-radius:6px; padding:6px; margin-top:4px;">
          </div>
        </div>`;
    } else if (data.payAtTicketOffice) {
      html += `<p style="margin-top:10px;">Pagarás en boletería el día de la visita.</p>`;
    }

    out.innerHTML = html;

  } catch (e) {
    out.innerHTML = `<div class="err"><strong>Fallo de red:</strong> ${e.message}</div>`;
  } finally {
    $("buyBtn").disabled = false;
  }
});
</script>
</body>
</html>
