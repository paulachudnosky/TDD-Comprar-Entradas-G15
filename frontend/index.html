<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Comprar Entradas - EcoHarmony Park</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>Comprar Entradas</h1>

  <div class="main-layout">

    <div class="main-form-col">
      <fieldset>
        <h3 class="fieldset-legend">Datos de compra</h3>
        <div class="row">
          <div>
            <label>Email del comprador
              <input id="email" type="email" placeholder="tu@email.com" required />
            </label>
            <div class="validation-error" id="email-error"></div>
          </div>
          <div>
            <label>Fecha de visita
              <input id="date" type="date" required />
            </label>
            <div class="validation-error" id="date-error"></div>
          </div>
          <div>
            <label>Forma de pago
              <select id="payment">
                <option value="Unspecified">-- Seleccionar --</option>
                <option value="Cash">Efectivo (boletería)</option>
                <option value="Card">Tarjeta (Mercado Pago)</option>
              </select>
            </label>
            <div class="validation-error" id="payment-error"></div>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <h3 class="fieldset-legend">Entradas</h3>
        <div class="row">
          <div class="panel">
            <strong>Pase Regular</strong>
            <div class="muted">Precio: $5.000</div>
            <label style="margin-top:8px;">Cantidad
              <input id="qtyRegular" type="number" min="0" max="10" value="0" />
            </label>
            <div class="validation-error" id="qty-error"></div>
          </div>
          <div class="panel">
            <strong>Pase VIP</strong>
            <div class="muted">Precio: $10.000</div>
            <label style="margin-top:8px;">Cantidad
              <input id="qtyVip" type="number" min="0" max="10" value="0" />
            </label>
          </div>
        </div>
      </fieldset>
      
    </div>
    <div class="main-ages-col">
      
      <div id="agesContainer" class="ages-scroll-area">
        <p class="muted" style="padding:10px;">Agrega entradas a la izquierda para registrar las edades de los visitantes.</p>
      </div>

      <div class="card" style="margin-top:16px;">
        <div class="muted">Subtotal Regular: <span id="subReg">$0</span></div>
        <div class="muted">Subtotal VIP: <span id="subVip">$0</span></div>
        <div class="total">Total: <span id="total">$0</span></div>
        <div class="muted" id="total-tickets-message">Máximo total de 10 entradas entre ambos tipos.</div>
      
        <button id="buyBtn" style="width: 100%; margin-top: 16px;">Comprar</button>
        <div id="out" style="margin-top:16px;"></div>
      </div>
    </div>
    </div>


  <script>
    // --- CAMBIO: Constantes JS actualizadas ---
    const PRICE_REG = 5000;
    const PRICE_VIP = 10000;
    const MAX_TICKETS = 10;
    const apiBase = "http://localhost:5080";

    const $ = id => document.getElementById(id);
    const fmt = n => n.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 });

    // Fecha mínima: hoy
    (() => {
      const today = new Date();
      const iso = today.toISOString().slice(0, 10);
      $("date").setAttribute("min", iso);
    })();

    function calcPrice(age, base) {
      if (age === null || age === 0) return 0;
      if (age <= 3) return 0;
      if (age >= 4 && age <= 15) return Math.round(base / 2);
      if (age >= 16 && age <= 59) return base;
      if (age >= 60) return Math.round(base / 2);
      return base;
    }

    function priceLabel(age, base) {
      if (age === null || age === 0) return "—";
      if (age <= 3) return "Gratis";
      if (age >= 4 && age <= 15) return `Mitad ${fmt(Math.round(base / 2))}`;
      if (age >= 16 && age <= 59) return `Completo ${fmt(base)}`;
      if (age >= 60) return `Mitad ${fmt(Math.round(base / 2))}`;
      return "—";
    }

    function enforceLimit() {
      let qR = parseInt($("qtyRegular").value || "0", 10);
      let qV = parseInt($("qtyVip").value || "0", 10);
      const total = qR + qV;
      
      const totalMsg = $("total-tickets-message");
      if(totalMsg) {
        totalMsg.textContent = `Total ${total} de ${MAX_TICKETS} entradas.`;
        if (total >= MAX_TICKETS) {
          totalMsg.style.color = 'var(--danger)'; 
        } else {
          totalMsg.style.color = 'var(--muted)';
        }
      }

      if (total > MAX_TICKETS) {
        const diff = total - MAX_TICKETS;
        if (document.activeElement.id === "qtyRegular" && qR > 0) {
          qR -= diff;
          $("qtyRegular").value = qR;
        } else if (document.activeElement.id === "qtyVip" && qV > 0) {
          qV -= diff;
          $("qtyVip").value = qV;
        }
      }
    }

    function renderAges() {
      enforceLimit(); 
      const cont = $("agesContainer");
      cont.innerHTML = ""; 

      const qR = parseInt($("qtyRegular").value || "0", 10);
      const qV = parseInt($("qtyVip").value || "0", 10);

      if (qR === 0 && qV === 0) {
        cont.innerHTML = '<p class="muted" style="padding:10px;">Agrega entradas a la izquierda para registrar las edades de los visitantes.</p>';
        recalc(); 
        return; 
      }

      const regDiv = document.createElement("div");
      const vipDiv = document.createElement("div");

      if (qR > 0) {
        regDiv.innerHTML = `<h3 class="fieldset-legend">Edades de Entradas Regulares</h3>`;
        for (let i = 0; i < qR; i++) {
          const box = document.createElement("div");
          box.className = "age-box regular-box";
          box.innerHTML = `
            <label>Edad visitante Regular ${i + 1}
              <input type="number" min="0" max="120" class="ageInput" data-type="Regular" placeholder="Edad">
            </label>
            <div class="price-label" id="lblReg${i}">—</div>
          `;
          regDiv.appendChild(box);
        }
      }

      if (qV > 0) {
        vipDiv.innerHTML = `<h3 class="fieldset-legend">Edades de Entradas VIP</h3>`;
        for (let i = 0; i < qV; i++) {
          const box = document.createElement("div");
          box.className = "age-box vip-box";
          box.innerHTML = `
            <label>Edad visitante VIP ${i + 1}
              <input type="number" min="0" max="120" class="ageInput" data-type="VIP" placeholder="Edad">
            </label>
            <div class="price-label" id="lblVip${i}">—</div>
          `;
          vipDiv.appendChild(box);
        }
      }

      cont.appendChild(regDiv);
      cont.appendChild(vipDiv);

      document.querySelectorAll(".ageInput").forEach(inp => {
        inp.addEventListener("input", recalc);
      });

      recalc();
    }

    function recalc() {
      const ageInputs = Array.from(document.querySelectorAll(".ageInput"));
      let subR = 0, subV = 0;

      ageInputs.forEach(inp => {
        const val = inp.value.trim();
        const age = val === "" ? null : parseInt(val, 10);
        const type = inp.dataset.type;
        const base = type === "Regular" ? PRICE_REG : PRICE_VIP;
        const price = calcPrice(age, base);

        if (type === "Regular") subR += price;
        else subV += price;

        const lbl = inp.parentElement.nextElementSibling;
        lbl.textContent = priceLabel(age, base);
      });

      $("subReg").textContent = fmt(subR);
      $("subVip").textContent = fmt(subV);
      $("total").textContent = fmt(subR + subV);
    }

    $("qtyRegular").addEventListener("input", renderAges);
    $("qtyVip").addEventListener("input", renderAges);

    renderAges();

    $("buyBtn").addEventListener("click", async () => {
      const out = $("out");
      out.innerHTML = "Procesando…";
      
      document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
      document.querySelectorAll('.validation-error').forEach(el => el.textContent = ''); 

      const email = $("email").value.trim();
      const date = $("date").value;
      const payment = $("payment").value;
      const qR = parseInt($("qtyRegular").value || "0", 10);
      const qV = parseInt($("qtyVip").value || "0", 10);

      let hasError = false; 

      if (!email) {
        $("email").classList.add('is-invalid');
        $("email-error").textContent = "El email es obligatorio."; 
        hasError = true;
      } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { 
        $("email").classList.add('is-invalid');
        $("email-error").textContent = "El formato del mail es inválido."; 
        hasError = true;
      }

      if (!date) {
        $("date").classList.add('is-invalid');
        $("date-error").textContent = "La fecha de visita es obligatoria."; 
        hasError = true;
      }

      if (payment === "Unspecified") {
        $("payment").classList.add('is-invalid');
        $("payment-error").textContent = "La forma de pago es obligatoria."; 
        hasError = true;
      }

      if (qR + qV === 0) {
        $("qtyRegular").classList.add('is-invalid');
        $("qtyVip").classList.add('is-invalid');
        $("qty-error").textContent = "Debes seleccionar al menos 1 entrada."; 
        hasError = true;
      }

      if (hasError) {
        out.innerHTML = `<div class="err"><strong>Error:</strong> Revisa los campos marcados.</div>`;
        return; 
      }

      const ageInputs = Array.from(document.querySelectorAll(".ageInput"));
      const visitors = ageInputs.map(inp => {
        const age = inp.value === "" ? 0 : parseInt(inp.value, 10);
        const rawType = inp.dataset.type;
        const passType = rawType === 'VIP' || rawType === 'vip' ? 'Vip' : 'Regular';
        return {
          age,
          passType,
          // El precio se envía al backend
          price: calcPrice(age, passType === "Regular" ? PRICE_REG : PRICE_VIP)
        };
      });

      const req = {
        userId: (crypto.randomUUID && crypto.randomUUID()) || "11111111-1111-1111-1111-111111111111",
        buyerEmail: email,
        visitDate: date,
        visitors,
        paymentMethod: payment,
        currency: "ARS"
      };

      try {
        $("buyBtn").disabled = true;
        const r = await fetch(apiBase + "/tickets/purchase", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(req)
        });
        
        if (!r.ok) {
          const data = await r.json();
          
          if (r.status === 400 && data.errors) {
            let errorMessages = [];
            const fieldMap = {
              'BuyerEmail': 'email',
              'VisitDate': 'date',
              'PaymentMethod': 'payment',
              'Visitors': 'qtyRegular'
            };

            for (const key in data.errors) {
              const message = data.errors[key].join(', '); 
              errorMessages.push(message);

              if (fieldMap[key]) {
                const inputId = fieldMap[key];
                $(inputId).classList.add('is-invalid');
                
                let errorDivId = `${inputId}-error`;
                if (key === 'Visitors') errorDivId = 'qty-error'; 
                
                if ($(errorDivId)) {
                  $(errorDivId).textContent = message;
                }
                
                if(key === 'Visitors') $("qtyVip").classList.add('is-invalid');
              }
            }
            out.innerHTML = `<div class="err"><strong>Error del servidor:</strong> Revisa los campos.</div>`;
          
          } else {
            out.innerHTML = `<div class="err"><strong>Error:</strong> ${data.error || r.statusText || "Solicitud inválida"}</div>`;
          }
          return; 
        }

        const data = await r.json();
        
        localStorage.setItem("eh_last_purchase", JSON.stringify({
          req, res: data, createdAt: new Date().toISOString()
        }));

        if (payment === "Card") window.location.href = "checkout.html";
        else window.location.href = "purchase-details.html";

      } catch (e) {
        out.innerHTML = `<div class"err"><strong>Fallo de red:</strong> No se pudo conectar al servidor.</div>`;
      } finally {
        $("buyBtn").disabled = false;
      }
    });
  </script>
</body>
</html>
