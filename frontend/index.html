<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Comprar Entradas - EcoHarmony Park</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      max-width: 900px;
      margin: 24px auto;
      padding: 0 12px;
    }
    h1 { margin-bottom: 16px; }

    fieldset {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 16px;
    }

    legend { font-weight: bold; }

    label { display: block; margin: 6px 0; }

    input, select, button {
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
    }

    .row { display: flex; flex-wrap: wrap; gap: 12px; }
    .row > div { flex: 1 1 240px; min-width: 220px; }

    .panel {
      border: 1px solid #eee;
      border-radius: 10px;
      background: #fafafa;
      padding: 10px;
      margin-top: 10px;
    }

    .muted { color: #666; font-size: 0.9rem; }
    .total { font-weight: bold; font-size: 1.1rem; }

    .age-box {
      border-radius: 8px;
      padding: 10px;
      margin: 6px 0;
    }
    .regular-box { background: #e8f9e8; border: 1px solid #b4dfb4; }
    .vip-box { background: #e8f0ff; border: 1px solid #b4c8ff; }

    .price-label { font-size: 0.85rem; color: #333; margin-top: 3px; }

    .err { color: #a00; }
    .ok { color: #0a0; }
  </style>
</head>
<body>
  <h1>Comprar Entradas</h1>

  <fieldset>
    <legend>Datos de compra</legend>
    <div class="row">
      <div>
        <label>Email del comprador
          <input id="email" type="email" placeholder="tu@email.com" required />
        </label>
      </div>
      <div>
        <label>Fecha de visita
          <input id="date" type="date" required />
        </label>
      </div>
      <div>
        <label>Forma de pago
          <select id="payment">
            <option value="Unspecified">-- Seleccionar --</option>
            <option value="Cash">Efectivo (boleterÃ­a)</option>
            <option value="Card">Tarjeta (Mercado Pago)</option>
          </select>
        </label>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Entradas</legend>
    <div class="row">
      <div class="panel">
        <strong>Pase Regular</strong>
        <div class="muted">Precio: $15.000</div>
        <label style="margin-top:8px;">Cantidad
          <input id="qtyRegular" type="number" min="0" max="10" value="0" />
        </label>
      </div>
      <div class="panel">
        <strong>Pase VIP</strong>
        <div class="muted">Precio: $25.000</div>
        <label style="margin-top:8px;">Cantidad
          <input id="qtyVip" type="number" min="0" max="10" value="0" />
        </label>
      </div>
    </div>

    <div class="panel" style="margin-top:12px;">
      <div class="muted">Subtotal Regular: <span id="subReg">$0</span></div>
      <div class="muted">Subtotal VIP: <span id="subVip">$0</span></div>
      <div class="total">Total: <span id="total">$0</span></div>
      <div class="muted">MÃ¡ximo total de 10 entradas entre ambos tipos.</div>
    </div>

    <div id="agesContainer" style="margin-top:14px;"></div>
  </fieldset>

  <button id="buyBtn">Comprar</button>
  <div id="out" style="margin-top:16px;"></div>

  <script>
    const PRICE_REG = 15000;
    const PRICE_VIP = 25000;
    const MAX_TICKETS = 10;
    const apiBase = "http://localhost:5080";

    const $ = id => document.getElementById(id);
    const fmt = n => n.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 });

    // Fecha mÃ­nima: hoy
    (() => {
      const today = new Date();
      const iso = today.toISOString().slice(0, 10);
      $("date").setAttribute("min", iso);
    })();

    function calcPrice(age, base) {
      if (age === null || age === 0) return 0;
      if (age <= 3) return 0;
      if (age >= 4 && age <= 15) return Math.round(base / 2);
      if (age >= 16 && age <= 59) return base;
      if (age >= 60) return Math.round(base / 2);
      return base;
    }

    function priceLabel(age, base) {
      if (age === null || age === 0) return "â€”";
      if (age <= 3) return "Gratis";
      if (age >= 4 && age <= 15) return `Mitad ${fmt(Math.round(base / 2))}`;
      if (age >= 16 && age <= 59) return `Completo ${fmt(base)}`;
      if (age >= 60) return `Mitad ${fmt(Math.round(base / 2))}`;
      return "â€”";
    }

    function enforceLimit() {
      let qR = parseInt($("qtyRegular").value || "0", 10);
      let qV = parseInt($("qtyVip").value || "0", 10);
      const total = qR + qV;
      if (total > MAX_TICKETS) {
        const diff = total - MAX_TICKETS;
        // Reducir el Ãºltimo modificado
        if (document.activeElement.id === "qtyRegular" && qR > 0) {
          qR -= diff;
          $("qtyRegular").value = qR;
        } else if (document.activeElement.id === "qtyVip" && qV > 0) {
          qV -= diff;
          $("qtyVip").value = qV;
        }
      }
    }

    function renderAges() {
      enforceLimit();
      const cont = $("agesContainer");
      cont.innerHTML = "";

      const qR = parseInt($("qtyRegular").value || "0", 10);
      const qV = parseInt($("qtyVip").value || "0", 10);

      if (qR === 0 && qV === 0) return;

      const regDiv = document.createElement("div");
      const vipDiv = document.createElement("div");

      if (qR > 0) {
        regDiv.innerHTML = `<h3>ðŸŸ© Edades de Entradas Regulares</h3>`;
        for (let i = 0; i < qR; i++) {
          const box = document.createElement("div");
          box.className = "age-box regular-box";
          box.innerHTML = `
            <label>Edad visitante Regular ${i + 1}
              <input type="number" min="0" max="120" class="ageInput" data-type="Regular" placeholder="Edad">
            </label>
            <div class="price-label" id="lblReg${i}">â€”</div>
          `;
          regDiv.appendChild(box);
        }
      }

      if (qV > 0) {
        vipDiv.innerHTML = `<h3>ðŸŸ¦ Edades de Entradas VIP</h3>`;
        for (let i = 0; i < qV; i++) {
          const box = document.createElement("div");
          box.className = "age-box vip-box";
          box.innerHTML = `
            <label>Edad visitante VIP ${i + 1}
              <input type="number" min="0" max="120" class="ageInput" data-type="VIP" placeholder="Edad">
            </label>
            <div class="price-label" id="lblVip${i}">â€”</div>
          `;
          vipDiv.appendChild(box);
        }
      }

      cont.appendChild(regDiv);
      cont.appendChild(vipDiv);

      document.querySelectorAll(".ageInput").forEach(inp => {
        inp.addEventListener("input", recalc);
      });

      recalc();
    }

    function recalc() {
      const ageInputs = Array.from(document.querySelectorAll(".ageInput"));
      let subR = 0, subV = 0;

      ageInputs.forEach(inp => {
        const val = inp.value.trim();
        const age = val === "" ? null : parseInt(val, 10);
        const type = inp.dataset.type;
        const base = type === "Regular" ? PRICE_REG : PRICE_VIP;
        const price = calcPrice(age, base);

        if (type === "Regular") subR += price;
        else subV += price;

        const lbl = inp.parentElement.nextElementSibling;
        lbl.textContent = priceLabel(age, base);
      });

      $("subReg").textContent = fmt(subR);
      $("subVip").textContent = fmt(subV);
      $("total").textContent = fmt(subR + subV);
    }

    $("qtyRegular").addEventListener("input", renderAges);
    $("qtyVip").addEventListener("input", renderAges);

    $("buyBtn").addEventListener("click", async () => {
      const out = $("out");
      out.textContent = "Procesandoâ€¦";

      const email = $("email").value.trim();
      const date = $("date").value;
      const payment = $("payment").value;
      const qR = parseInt($("qtyRegular").value || "0", 10);
      const qV = parseInt($("qtyVip").value || "0", 10);

      const ageInputs = Array.from(document.querySelectorAll(".ageInput"));
      const visitors = ageInputs.map(inp => {
        const age = inp.value === "" ? 0 : parseInt(inp.value, 10);
        // Normalize passType casing to match backend enums (Regular, Vip)
        const rawType = inp.dataset.type;
        const passType = rawType === 'VIP' || rawType === 'vip' ? 'Vip' : 'Regular';
        return {
          age,
          passType,
          price: calcPrice(age, passType === "Regular" ? PRICE_REG : PRICE_VIP)
        };
      });

      const req = {
        userId: (crypto.randomUUID && crypto.randomUUID()) || "11111111-1111-1111-1111-111111111111",
        buyerEmail: email,
        visitDate: date,
        visitors,
        paymentMethod: payment,
        currency: "ARS"
      };

      try {
        $("buyBtn").disabled = true;
        const r = await fetch(apiBase + "/tickets/purchase", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(req)
        });
        const data = await r.json();

        if (!r.ok) {
          out.innerHTML = `<div class="err"><strong>Error:</strong> ${data.error || "Solicitud invÃ¡lida"}</div>`;
          return;
        }

        // Store wrapper { req, res, createdAt } so other pages can read request + response
        localStorage.setItem("eh_last_purchase", JSON.stringify({
          req, res: data, createdAt: new Date().toISOString()
        }));

        if (payment === "Card") window.location.href = "checkout.html";
        else window.location.href = "purchase-details.html";

      } catch (e) {
        out.innerHTML = `<div class="err"><strong>Fallo de red:</strong> ${e.message}</div>`;
      } finally {
        $("buyBtn").disabled = false;
      }
    });
  </script>
</body>
</html>
